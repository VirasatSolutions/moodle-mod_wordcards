define(["jquery","core/ajax","core/log","mod_wordcards/a4e","core/templates"],function(a,b,c,d,e){var f={dryRun:!1,init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl,this.modid=b.modid;var g=a(e).get(0);if(!g)return void c.debug("No config found on page. Giving up.");var h=JSON.parse(g.value);a(e).remove(),f.process(h),d.register_events(),d.init_audio(b.token,b.region,b.owner),this.register_events()},register_events:function(){a("body").on("click","#close-results",function(){var a=f.timer.count,b=f.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a;window.location.replace(b)}),a("body").on("click","#try-again",function(){location.reload()}),a("body").on("click",".a4e-distractor",function(b){f.check(a(this).data("correct"),this)}),a("body").on("click","#start-button",function(){f.start()})},process:function(a){f.terms=a.terms,f.has_images=a.has_images,d.list_vocab("#vocab-list-inner",f.terms)},start:function(){f.results=[],d.shuffle(f.terms),f.pointer=0,a("#vocab-list, #start-button").hide(),a("#gameboard").show(),a("#time-counter").text("00:00"),f.timer={interval:setInterval(function(){f.timer.update()},1e3),count:0,update:function(){f.timer.count++,a("#time-counter").text(d.pretty_print_secs(f.timer.count))}},f.next()},quit:function(){clearInterval(f.timer.interval),a("#gameboard").hide(),a("#vocab-list, #start-button").show()},end:function(){clearInterval(f.timer.interval),a("#gameboard, #start-button").hide(),a("#results").show();var c=[];c.results=f.results,c.total=f.terms.length,c.totalcorrect=d.calc_total_points(f.results);var g=f.timer.count;0==g?c.prettytime="00:00":c.prettytime=d.pretty_print_secs(g),e.render("mod_wordcards/feedback",c).then(function(b,c){a("#results-inner").html(b)});var h={results:f.results,activity:"match_select"};console.log(h),b.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:f.modid,correct:c.totalcorrect}}])},next:function(){d.progress_dots(f.results,f.terms);var b="";f.terms[f.pointer].image&&(b+="<img class='a4e-prompt-img' src='"+f.terms[f.pointer].image+"'>"),b+="<strong>"+f.terms[f.pointer].definition+"</strong>",a("#question").html(b),a("#input").html(f.get_distractors())},check:function(b,c){var d=0;1==b&&(d=1),a(".a4e-distractor").css("pointer-events","none");var e={question:f.terms[f.pointer].definition,selected:a(c).text(),correct:f.terms[f.pointer].term,points:d};f.results.push(e);var g=1==b?"a4e-correct":"a4e-incorrect";a(c).addClass(g).append("<i style='color:"+(b?"green":"red")+";margin-left:5px;' class='fa fa-"+(b?"check":"times")+"'></i>").parent().addClass("a4e-click-disabled"),b||a(".a4e-distractor[data-correct='true']").addClass("a4e-correct").append("<i style='color:green;margin-left:5px;' class='fa fa-check'></i>"),b?this.reportSuccess(f.terms[f.pointer].id):this.reportFailure(f.terms[f.pointer].id,a(c).data("id")),f.pointer++,b?setTimeout(function(){f.pointer<f.terms.length?f.next():f.end()},1e3):setTimeout(function(){f.pointer<f.terms.length?f.next():f.end()},1500)},get_distractors:function(){var b=f.terms.slice(0),c=f.terms[f.pointer].term;b.splice(f.pointer,1),d.shuffle(b),b=b.slice(0,4),b.push(f.terms[f.pointer]),d.shuffle(b);var e=[];a.each(b,function(a,b){var d=b.term==c,f=b.id;e.push('<li data-id="'+f+'" data-correct="'+d.toString()+'" class="list-group-item a4e-distractor a4e-noselect">'+b.term+"</li>")});var g='<ul class="list-group a4e-distractors">'+e.join("")+"</ul>";return g},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return f});