define(["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/keyboard","mod_wordcards/pollyhelper","core/templates"],function(a,b,c,d,e,f,g){var h={dryRun:!1,audio:!1,ttslanguage:"en-US",init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl;var g=a(e).get(0);if(!g)return void c.debug("No config found on page. Giving up.");var i=JSON.parse(g.value);a(e).remove(),f.init(b.token,b.region,b.owner),h.ttslanguage=b.ttslanguage,h.process(i),d.register_events(),this.register_events()},register_events:function(){var b=a("#dictation_player");a("#next-button").on("click",function(){h.next()}),a("body").on("click","#close-results",function(){var a=d.calc_total_time(h.results);window.location.replace(h.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a)}),a("#listen-button").click(function(){h.audio?(b.attr("src",h.audio),b[0].play()):f.fetch_polly_url(h.tts,"text",h.ttsvoice)}),f.onnewpollyurl=function(a){b.attr("src",a),b[0].play()},a("body").on("click","#start-button",function(){h.start()}),a("body").on("click","#quit-button",function(){h.quit()})},process:function(a){h.terms=a.terms,h.has_images=a.has_images,d.list_vocab("#vocab-list-inner",h.terms)},start:function(){h.results=[],d.shuffle(h.terms),h.pointer=0,a("#vocab-list, #start-button").hide(),a("#gameboard, #quit-button").show(),a("#time-counter").text("00:00"),a("#progress-correct").css("width","0%"),a("#progress-incorrect").css("width","0%"),h.timer={interval:setInterval(function(){h.timer.update()},1e3),count:0,update:function(){h.timer.count++,a("#time-counter").text(d.pretty_print_secs(h.timer.count))}},h.next()},quit:function(){e.clear(),clearInterval(h.timer.interval),a("#gameboard, #quit-button").hide(),a("#vocab-list, #start-button").show()},end:function(){e.clear(),clearInterval(h.timer.interval),a("#gameboard, #quit-button, #start-button").hide(),a("#results").show();var b=[];b.results=h.results,b.total=h.terms.length,b.totalcorrect=d.calc_total_points(h.results);var c=d.calc_total_time(h.results);0==c?b.prettytime="00:00":b.prettytime=d.pretty_print_secs(c),g.render("mod_wordcards/feedback",b).then(function(b,c){a("#results-inner").html(b)});var f={results:h.results,activity:"dictation"};console.log(f)},next:function(){a("#next-button").hide(),a("#submitted").html("").removeClass("a4e-correct a4e-incorrect"),e.create("input",h.terms[h.pointer].term,h.pointer,!0,function(b){a("#submitted").html(h.terms[h.pointer].term),e.disable(),h.check(b)}),a("#question-counter").text(h.pointer+1+"/"+h.terms.length);var b={correct:h.results.filter(function(a){return a.points>0}).length/h.terms.length*100,incorrect:h.results.filter(function(a){return 0==a.points}).length/h.terms.length*100};a("#progress-correct").css("width",b.correct+"%"),a("#progress-incorrect").css("width",b.incorrect+"%"),h.tts=h.terms[h.pointer].term,h.terms[h.pointer].ttsvoice?h.ttsvoice=h.terms[h.pointer].ttsvoice:h.ttsvoice="auto",h.terms[h.pointer].audio?h.audio=h.terms[h.pointer].audio:h.audio=!1,a("#listen-button").trigger("click")},check:function(b){var c=b.toLowerCase().trim()==h.terms[h.pointer].term.toLowerCase().trim(),d=0;1==c?(a("#submitted").addClass("a4e-correct"),d=1):a("#submitted").addClass("a4e-incorrect"),c?this.reportSuccess(h.terms[h.pointer].id):this.reportFailure(h.terms[h.pointer].id,0);var e={question:h.terms[h.pointer].definition,selected:b,correct:h.terms[h.pointer].term,points:d,time:h.timer.count};h.timer.count=0,h.results.push(e),h.pointer<h.terms.length-1?(h.pointer++,c?setTimeout(function(){a("#next-button").trigger("click")},1e3):a("#next-button").show()):h.end()},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return h});