{"version":3,"sources":["../src/cards.js"],"names":["define","$","Ajax","CARDMARGIN","shuffleArray","array","i","length","j","Math","floor","random","temp","Cards","selector","terms","_container","_terms","_selected","prototype","_dryRun","_resizeTimeout","init","pool","forEach","item","push","_makeCard","id","term","definition","bind","append","_arrangePlayground","show","on","_handlePick","window","clearTimeout","setTimeout","width","height","perRow","cardCount","cardWidth","cardHeight","row","col","lineHeight","lineHeightValue","lineHeightUnit","suggestedHeight","find","first","css","parseInt","replace","min","round","ceil","each","index","top","left","_adjustCardContent","el","node","over","txt","loops","text","data","scrollHeight","offsetHeight","max","substr","trim","_checkComplete","_trigger","e","preventDefault","card","currentTarget","hasClass","addClass","is","animate","_reportSuccess","original","_reportFailure","removeClass","container","wrapper","content","action","cb","term1id","term2id","call","methodname","args","termid","setDryRun","value","trigger"],"mappings":"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","sourcesContent":["/**\n * Cards module.\n *\n * @package mod_wordcards\n * @author  Frédéric Massart - FMCorz.net\n */\n\n// TODO Handle window resizing/rotating?\n// TODO Test Edge\n\ndefine([\n    'jquery',\n    'core/ajax',\n], function($, Ajax) {\n\n    var PAGEOFFSET = 60;\n    var CARDMARGIN = 4;\n\n    /**\n     * Randomize array element order in-place.\n     * Using Durstenfeld shuffle algorithm.\n     * @see http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array\n     */\n    function shuffleArray(array) {\n        for (var i = array.length - 1; i > 0; i--) {\n            var j = Math.floor(Math.random() * (i + 1));\n            var temp = array[i];\n            array[i] = array[j];\n            array[j] = temp;\n        }\n        return array;\n    }\n\n    var Cards = function(selector, terms) {\n        this._container = $(selector);\n        this._terms = terms;\n        this._selected = null;\n    };\n    Cards.prototype._container = null;\n    Cards.prototype._dryRun = false;\n    Cards.prototype._resizeTimeout = null;\n    Cards.prototype._selected = null;\n    Cards.prototype._terms = null;\n\n    Cards.prototype.init = function() {\n        var pool = [];\n\n        this._terms.forEach(function(item) {\n            pool.push(this._makeCard(item.id, item.term));\n            pool.push(this._makeCard(item.id, item.definition));\n        }.bind(this));\n\n        shuffleArray(pool);\n        pool.forEach(function(item) {\n            // item.hide();\n            this._container.append(item);\n        }.bind(this));\n        this._arrangePlayground();\n        pool.forEach(function(item) {\n            item.show();\n        });\n\n        // Event listeners.\n        this._container.on('click', '.wordcard', this._handlePick.bind(this));\n        $(window).on('resize', function() {\n            if (this._resizeTimeout) {\n                clearTimeout(this._resizeTimeout);\n            }\n            this._resizeTimeout = setTimeout(this._arrangePlayground.bind(this), 200);\n        }.bind(this));\n    };\n\n    Cards.prototype._arrangePlayground = function() {\n        var width = this._container.width(),\n            height = $(window).height(),\n            perRow = 3,\n            cardCount = this._terms.length * 2,\n            cardWidth = null,\n            cardHeight = null,\n            row = 0,\n            col = 0,\n            lineHeight,\n            lineHeightValue,\n            lineHeightUnit,\n            suggestedHeight;\n\n        if (cardCount % 2 < cardCount % 3) {\n            perRow = 2;\n        }\n        lineHeight = this._container.find('.wordcard').first().css('lineHeight');\n        lineHeightValue = parseInt(lineHeight.replace(/([^0-9]+)/, ''));\n        lineHeightUnit = lineHeight.replace(/([0-9]+)/, '');\n        suggestedHeight = 60;\n        if (lineHeightUnit === 'px') {\n            suggestedHeight = !lineHeightValue ? suggestedHeight : ((lineHeightValue + 1) * 3);\n        }\n        suggestedHeight = 999;\n\n        cardWidth = Math.floor(width / perRow);\n        cardHeight = Math.min(Math.round((height - PAGEOFFSET) / Math.ceil(cardCount / perRow)), suggestedHeight);\n\n        this._container.find('.wordcard').each(function(index, item) {\n            $(item).css({\n                top: row * cardHeight,\n                left: col * cardWidth,\n                width: (col == perRow - 1) ? cardWidth : cardWidth - CARDMARGIN,\n                height: cardHeight - CARDMARGIN\n            });\n            col++;\n            if (col >= perRow) {\n                col = 0;\n                row++;\n            }\n        });\n\n        this._container.find('.wordcard-content').css('maxHeight', cardHeight - CARDMARGIN);\n        this._container.css({height: row * cardHeight});\n        this._adjustCardContent();\n    };\n\n    Cards.prototype._adjustCardContent = function() {\n        this._container.find('.wordcard-content').each(function(index, el) {\n            var node = $(el),\n                over,\n                txt,\n                loops = 0;\n\n            node.text(node.data('text'));\n            while (el.scrollHeight > el.offsetHeight && el.scrollHeight > 0) {\n                txt = node.text();\n                over = Math.max(0.1, (el.offsetHeight / el.scrollHeight) - 0.05);\n                txt = txt.substr(0, Math.round(txt.length * over)).trim();\n                txt += '…';\n                node.text(txt);\n\n                // Fail safe, because sometimes it loops forever...\n                if (loops++ > 4) {\n                    break;\n                }\n            }\n        });\n    };\n\n    Cards.prototype._checkComplete = function() {\n        if (this._container.find('.wordcard.found').length == this._terms.length * 2) {\n            this._trigger('complete');\n        }\n    };\n\n    Cards.prototype._handlePick = function(e) {\n        e.preventDefault();\n        var card = $(e.currentTarget);\n\n        // It's already invisible.\n        if (card.hasClass('found')) {\n            return;\n        }\n\n        // It's the first out of the two picks.\n        if (!this._selected) {\n            this._selected = card;\n            card.addClass('selected');\n            return;\n        }\n\n        // We've clicked the selected card.\n        if (this._selected.is(card)) {\n            return;\n        }\n\n        // It's a match!\n        if (card.data('id') == this._selected.data('id')) {\n            this._selected\n                .addClass('found')\n                .animate({'opacity': 0});\n            card.addClass('found')\n                .animate({'opacity': 0});\n\n            this._reportSuccess(this._selected.data('id'));\n            this._checkComplete();\n\n        // It's not a match...\n        } else {\n            var original = this._selected;\n            original.addClass('mismatch');\n            card.addClass('mismatch');\n\n            this._reportFailure(this._selected.data('id'), card.data('id'));\n\n            setTimeout(function() {\n                original.removeClass('mismatch');\n                card.removeClass('mismatch');\n            }, 600);\n        }\n\n        // Reset the selection.\n        this._selected.removeClass('selected');\n        this._selected = null;\n    };\n\n    Cards.prototype._makeCard = function(id, text) {\n        var container = $('<div class=\"wordcard\">'),\n            wrapper = $('<div class=\"wordcard-wrapper\">'),\n            content = $('<div class=\"wordcard-content\">');\n\n        content.text(text);\n        content.data('text', text);\n        wrapper.append(content);\n        container.append(wrapper);\n        container.data('id', id);\n\n        return container;\n    };\n\n    Cards.prototype.on = function(action, cb) {\n        this._container.on(action, cb);\n    };\n\n    Cards.prototype._reportFailure = function(term1id, term2id) {\n        if (this._dryRun) {\n            return;\n        }\n\n        Ajax.call([{\n            methodname: 'mod_wordcards_report_failed_association',\n            args: {\n                term1id: term1id,\n                term2id: term2id\n            }\n        }]);\n    };\n\n    Cards.prototype._reportSuccess = function(termid) {\n        if (this._dryRun) {\n            return;\n        }\n\n        Ajax.call([{\n            methodname: 'mod_wordcards_report_successful_association',\n            args: {\n                termid: termid\n            }\n        }]);\n    };\n\n    Cards.prototype.setDryRun = function(value) {\n        this._dryRun = value;\n    };\n\n    Cards.prototype._trigger = function(action) {\n        this._container.trigger(action);\n    };\n\n    return Cards;\n\n});\n"],"file":"cards.min.js"}