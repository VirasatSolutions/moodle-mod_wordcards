define(["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","core/templates"],function(a,b,c,d,e,f,g){var h={passmark:75,pointer:1,jsondata:null,props:null,glider:null,dryRun:!1,controls:{},init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl,this.modid=b.modid;var f=a(e).get(0);if(!f)return void c.debug("No config found on page. Giving up.");var g=JSON.parse(f.value);a(e).remove(),h.jsondata=g,h.props=b,h.process(g),d.register_events(),d.init_audio(b.token,b.region,b.owner),this.init_controls(),this.register_events()},init_controls:function(){h.controls.close_results=a("#close-results"),h.controls.results=a("#results"),h.controls.vocab_list=a("#vocab-list"),h.controls.the_list=a("#speechcards_thelist"),h.controls.gameboard=a("#gameboard"),h.controls.time_counter=a("#time-counter"),h.controls.prev_button=a(".wordcards-speechcards_prevbutton"),h.controls.next_button=a(".wordcards-speechcards_nextbutton"),h.controls.standalonepushrecorder=a(".speechcards_standalonerecorder")},do_next:function(){d.progress_dots(h.results,h.terms),h.clearStarRating(),h.is_end()?h.do_end():(h.glider.go(">"),h.update_header())},do_prev:function(){h.glider.go("<"),h.update_header()},clearStarRating:function(){a("#star-rating").html("· · ·")},register_events:function(){h.controls.prev_button.click(function(){h.do_prev()}),h.controls.next_button.click(function(){var a=h.terms[h.pointer-1].term;h.check(!1,a),h.do_next()}),a("body").on("click","#close-results",function(){var a=h.timer.count,b=h.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a;window.location.replace(b)}),a("body").on("click","#try-again",function(){location.reload()}),a("body").on("click","#start-button",function(){h.start()})},process:function(a){h.terms=a.terms,h.has_images=a.has_images,d.list_vocab("#vocab-list-inner",h.terms),this.initComponents()},initCards:function(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){h.pointer=a}var c="<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>",d=h.controls.the_list;a.each(h.jsondata.terms,function(a,b){d.append(c.replace("@thetext@",b.term))}),h.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function(a){b(a.index),h.update_header()},afterInit:function(a){b(a.index)}}).data("glide_api")})},initComponents:function(){var b=function(b){switch(console.log(b),b.type){case"recording":break;case"speech":var d=b.capturedspeech,e=h.cleanText(d),f=e,g=h.terms[h.pointer-1].term,i=h.similarity(f,g);if(c.debug("JS similarity: "+f+":"+g+":"+i),i>=h.passmark||h.wordsDoMatch(e,h.terms[h.pointer-1]))return c.debug("local match::"+f+":"+g),h.showStarRating(100),void h.flagCorrectAndTransition(h.terms[h.pointer-1]);h.checkByPhonetic(f,g).then(function(b){return b===!1?a.Deferred().reject():(c.debug("PHP similarity: "+f+":"+g+":"+b),h.showStarRating(b),b>=h.passmark&&h.flagCorrectAndTransition(b,h.terms[h.pointer-1]),void 0)})}};f.init("speechcards_pushrecorder",b)},showStarRating:function(b){var c=[!0,!0,!0];b<1&&(c=[!0,!0,!1]),b<h.passmark&&(c=[!0,!1,!1]),b<.5&&(c=[!1,!1,!1]),console.log(c,b);var d="";c.forEach(function(a){d+=a===!0?'<i class="fa fa-star"></i>':'<i class="fa fa-star-o"></i>'}),console.log(d),a("#star-rating").html(d)},flagCorrectAndTransition:function(a){h.check(!0,a),h.is_end()?(h.update_header(),setTimeout(function(){h.do_end()},700)):setTimeout(function(){h.do_next()},700)},checkByPhonetic:function(a,c){return b.call([{methodname:"mod_wordcards_check_by_phonetic",args:{spoken:a,correct:c,language:h.props.language}}])[0]},wordsDoMatch:function(b,c){if(b=h.cleanText(b),c.term=h.cleanText(c.term),b==c.term)return!0;if(!c.alternates)return!1;var d=c.alternates.split(","),e=!1;return a.each(d,function(a,c){if(h.cleanText(c.toLowerCase())==b)return e=!0,!1}),e},cleanText:function(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function(){h.results=[],d.shuffle(h.terms),h.controls.vocab_list.hide(),h.controls.gameboard.show(),h.controls.time_counter.text("00:00"),h.clearStarRating(),d.progress_dots(h.results,h.terms),h.timer={interval:setInterval(function(){h.timer.update()},1e3),count:0,update:function(){h.timer.count++,h.controls.time_counter.text(d.pretty_print_secs(h.timer.count))}},h.update_header(),this.initCards()},quit:function(){clearInterval(h.timer.interval),h.controls.gameboard.hide(),h.controls.vocab_list.show()},do_end:function(){clearInterval(h.timer.interval),a("#gameboard, #quit-button, #start-button").hide(),a("#results").show();var c=[];c.results=h.results,c.total=h.terms.length,c.totalcorrect=d.calc_total_points(h.results);var e=h.timer.count;0==e?c.prettytime="00:00":c.prettytime=d.pretty_print_secs(e),g.render("mod_wordcards/feedback",c).then(function(b,c){a("#results-inner").html(b)});var f={results:h.results,activity:"speechcards"};console.log(f),b.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:h.modid,correct:c.totalcorrect}}])},is_end:function(){return!(h.pointer<h.terms.length)},update_header:function(){({correct:h.results.filter(function(a){return a.points>0}).length/h.terms.length*100,incorrect:h.results.filter(function(a){return 0==a.points}).length/h.terms.length*100})},check:function(b,c){var d=1;d=1==b?1:0,a(".a4e-distractor").css("pointer-events","none");var e={pointer:h.pointer,question:h.terms[h.pointer-1].definition,selected:c,correct:h.terms[h.pointer-1].term,points:d};a.each(h.results,function(a){h.pointer===a.pointer}),h.results.push(e),b?this.reportSuccess(h.terms[h.pointer-1].id):this.reportFailure(h.terms[h.pointer-1].id,-1)},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])},similarity:function(a,b){var c=a,d=b;a.length<b.length&&(c=b,d=a);var e=c.length;return 0==e?1:(e-h.editDistance(c,d))/parseFloat(e)},editDistance:function(a,b){a=a.toLowerCase(),b=b.toLowerCase();for(var c=new Array,d=0;d<=a.length;d++){for(var e=d,f=0;f<=b.length;f++)if(0==d)c[f]=f;else if(f>0){var g=c[f-1];a.charAt(d-1)!=b.charAt(f-1)&&(g=Math.min(Math.min(g,e),c[f])+1),c[f-1]=e,e=g}d>0&&(c[b.length]=e)}return c[b.length]}};return h});