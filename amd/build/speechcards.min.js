define(["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","mod_wordcards/transcriber-lazy","core/templates"],function(a,b,c,d,e,f,g,h){var i={pointer:1,whatheard:null,jsondata:null,props:null,glider:null,dryRun:!1,controls:{},browserspeech:!1,init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl;var f=a(e).get(0);if(!f)return void c.debug("No config found on page. Giving up.");var f=JSON.parse(f.value);a(e).remove(),i.jsondata=f,i.props=b,i.process(f),i.whatheard=a("#submitted"),i.browserspeech="webkitSpeechRecognition"in window||"SpeechRecognition"in window,d.register_events(),this.init_controls(),this.register_events()},init_controls:function(){i.controls.close_results=a("#close-results"),i.controls.results=a("#results"),i.controls.vocab_list=a("#vocab-list"),i.controls.question_counter=a("#question-counter"),i.controls.quit_button=a("#quit-button"),i.controls.the_list=a("#speechcards_thelist"),i.controls.gameboard=a("#gameboard"),i.controls.time_counter=a("#time-counter"),i.controls.progress_correct=a("#progress-correct"),i.controls.progress_incorrect=a("#progress-incorrect"),i.controls.prev_button=a(".wordcards-speechcards_prevbutton"),i.controls.next_button=a(".wordcards-speechcards_nextbutton"),i.controls.standalonepushrecorder=a(".speechcards_standalonerecorder")},do_next:function(){i.is_end()?i.do_end():(i.whatheard.removeClass("wordcards-speechcards_gotit"),i.whatheard.text("........"),i.glider.go(">"),i.update_header())},do_prev:function(){i.whatheard.removeClass("wordcards-speechcards_gotit"),i.whatheard.text("........"),i.glider.go("<"),i.update_header()},register_events:function(){i.controls.prev_button.click(function(){i.do_prev(),i.update_whatheard()}),i.controls.next_button.click(function(){var a=i.terms[i.pointer-1].term;i.check(!1,a),i.do_next(),i.update_whatheard()}),a("body").on("click","#close-results",function(){var a=d.calc_total_time(i.results);window.location.replace(i.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a)}),a("body").on("click","#start-button",function(){i.start()}),i.controls.quit_button.click(function(){i.quit()})},process:function(a){i.terms=a.terms,i.has_images=a.has_images,d.list_vocab("#vocab-list-inner",i.terms),this.initComponents()},initCards:function(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){i.pointer=a}var c="<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>",d=i.controls.the_list;a.each(i.jsondata.terms,function(a,b){d.append(c.replace("@thetext@",b.term))}),i.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function(a){b(a.index),i.update_header()},afterInit:function(a){b(a.index)}}).data("glide_api")})},initComponents:function(){var a=function(a){switch(a.type){case"recording":if(i.browserspeech)return;"started"==a.action?i.startAWSTranscriber():"stopped"==a.action&&i.stopAWSTranscriber();break;case"speech":var b=a.capturedspeech,c=i.cleanText(b);i.wordsDoMatch(c,i.terms[i.pointer-1])?(i.whatheard.text(i.terms[i.pointer-1].term),i.whatheard.addClass("wordcards-speechcards_gotit"),i.check(!0,c),i.is_end()?(i.update_header(),setTimeout(function(){i.do_end()},700)):setTimeout(function(){i.do_next()},700)):i.whatheard.text(b)}};f.init("speechcards_pushrecorder",a);var b={};b.language=i.props.language,b.region=i.props.region,b.accessid=i.props.accessid,b.secretkey=i.props.secretkey,g.init(b),g.onFinalResult=function(b,c){var d={type:"speech"};d.capturedspeech=b,a(d)}},startAWSTranscriber:function(){g.active||window.navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(function(a){g.start(a,g)})["catch"](function(a){c.debug(a),c.debug("There was an error streaming your audio to Amazon Transcribe. Please try again.")})},stopAWSTranscriber:function(){g.active&&g.closeSocket()},wordsDoMatch:function(b,c){if(b==c.term)return!0;if(!c.alternates)return!1;var d=c.alternates.split(","),e=!1;return a.each(d,function(a,c){if(i.cleanText(c)==b)return e=!0,!1}),e},cleanText:function(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function(){i.results=[],d.shuffle(i.terms),i.controls.vocab_list.hide(),i.controls.gameboard.show(),i.controls.quit_button.show(),i.controls.time_counter.text("00:00"),i.controls.progress_correct.css("width","0%"),i.controls.progress_incorrect.css("width","0%"),i.whatheard.text("........"),i.timer={interval:setInterval(function(){i.timer.update()},1e3),count:0,update:function(){i.timer.count++,i.controls.time_counter.text(d.pretty_print_secs(i.timer.count))}},i.update_header(),this.initCards()},quit:function(){clearInterval(i.timer.interval),i.controls.gameboard.hide(),i.controls.quit_button.hide(),i.controls.vocab_list.show()},do_end:function(){clearInterval(i.timer.interval),a("#gameboard, #quit-button, #start-button").hide(),a("#results").show();var b=[];b.results=i.results,b.total=i.terms.length,b.totalcorrect=d.calc_total_points(i.results);var c=d.calc_total_time(i.results);0==c?b.prettytime="00:00":b.prettytime=d.pretty_print_secs(c),h.render("mod_wordcards/feedback",b).then(function(b,c){a("#results-inner").html(b)});var e={results:i.results,activity:"speechcards"};console.log(e)},is_end:function(){return!(i.pointer<i.terms.length)},update_whatheard:function(){a.each(i.results,function(a){i.pointer===a.pointer&&(i.whatheard.text(a.selected),i.cleanText(a.selected)===i.terms[i.pointer-1].term&&i.whatheard.addClass("wordcards-speechcards_gotit"))})},update_header:function(){var a={correct:i.results.filter(function(a){return a.points>0}).length/i.terms.length*100,incorrect:i.results.filter(function(a){return 0==a.points}).length/i.terms.length*100};i.controls.progress_correct.css("width",a.correct+"%"),i.controls.progress_incorrect.css("width",a.incorrect+"%"),i.controls.question_counter.text(i.pointer+"/"+i.terms.length)},check:function(b,c){var d=1;d=1==b?1:0,a(".a4e-distractor").css("pointer-events","none");var e={pointer:i.pointer,question:i.terms[i.pointer-1].definition,selected:c,correct:i.terms[i.pointer-1].term,points:d,time:i.timer.count};i.timer.count=0,a.each(i.results,function(a){i.pointer===a.pointer}),i.results.push(e),b?this.reportSuccess(i.terms[i.pointer-1].id):this.reportFailure(i.terms[i.pointer-1].id,-1)},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return i});