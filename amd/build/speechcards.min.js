define ("mod_wordcards/speechcards",["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","mod_wordcards/ttrecorder","core/templates"],function(a,b,c,d,e,f,g,h){var j={passmark:75,pointer:1,jsondata:null,props:null,glider:null,dryRun:!1,controls:{},init:function init(b){var e="#"+b.widgetid;this.dryRun=b.dryRun;this.nexturl=b.nexturl;this.modid=b.modid;var f=a(e).get(0);if(f){var g=JSON.parse(f.value);a(e).remove()}else{c.debug("No config found on page. Giving up.");return}j.jsondata=g;j.props=b;j.process(g);d.register_events();d.init_audio(b.token,b.region,b.owner);this.init_controls();this.register_events()},init_controls:function init_controls(){j.controls.close_results=a("#wordcards-close-results");j.controls.results=a("#wordcards-results");j.controls.vocab_list=a("#wordcards-vocab-list");j.controls.the_list=a("#speechcards_thelist");j.controls.gameboard=a("#wordcards-gameboard");j.controls.time_counter=a("#wordcards-time-counter");j.controls.prev_button=a(".wordcards-speechcards_prevbutton");j.controls.next_button=a(".wordcards-speechcards_nextbutton");j.controls.standalonepushrecorder=a(".speechcards_standalonerecorder")},do_next:function do_next(){d.progress_dots(j.results,j.terms);j.clearStarRating();if(!j.is_end()){j.glider.go(">");j.update_header()}else{j.do_end()}},do_prev:function do_prev(){j.glider.go("<");j.update_header()},clearStarRating:function clearStarRating(){a("#wordcards-star-rating").html("\xB7 \xB7 \xB7")},register_events:function register_events(){j.controls.prev_button.click(function(){j.do_prev()});j.controls.next_button.click(function(){var a=j.terms[j.pointer-1].term;j.check(!1,a);j.do_next()});a("body").on("click","#wordcards-close-results",function(){var a=j.timer.count,b=j.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a;window.location.replace(b)});a("body").on("click","#wordcards-try-again",function(){location.reload()});a("body").on("click","#wordcards-start-button",function(){j.start()})},process:function process(a){j.terms=a.terms;j.has_images=a.has_images;d.list_vocab("#vocab-list-inner",j.terms);this.initComponents()},initCards:function initCards(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){j.pointer=a}var c=j.controls.the_list;a.each(j.jsondata.terms,function(a,b){c.append("<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>".replace("@thetext@",b.term))});j.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function afterTransition(a){b(a.index);j.update_header()},afterInit:function afterInit(a){b(a.index)}}).data("glide_api")})},initComponents:function initComponents(){var b=this,d=function(b){console.log(b);switch(b.type){case"recording":break;case"speech":var d=b.capturedspeech,e=j.cleanText(d),f=e,g=j.terms[j.pointer-1].term,h=j.similarity(f,g);c.debug("JS similarity: "+f+":"+g+":"+h);if(h>=j.passmark||j.wordsDoMatch(e,j.terms[j.pointer-1])){c.debug("local match::"+f+":"+g);j.showStarRating(100);j.flagCorrectAndTransition(j.terms[j.pointer-1]);return}j.checkByPhonetic(f,g).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+f+":"+g+":"+b);j.showStarRating(b);if(b>=j.passmark){j.flagCorrectAndTransition(b,j.terms[j.pointer-1])}}});}},e="wordcards-speechcards_pushrecorder";if(this.use_ttrecorder()){g.clone().init({uniqueid:e,callback:d})}else{f.init(e,d)}},showStarRating:function showStarRating(b){var c=[!0,!0,!0];if(1>b){c=[!0,!0,!1]}if(b<j.passmark){c=[!0,!1,!1]}if(.5>b){c=[!1,!1,!1]}console.log(c,b);var d="";c.forEach(function(a){if(!0===a){d+="<i class=\"fa fa-star\"></i>"}else{d+="<i class=\"fa fa-star-o\"></i>"}});console.log(d);a("#wordcards-star-rating").html(d)},flagCorrectAndTransition:function flagCorrectAndTransition(a){j.check(!0,a);if(j.is_end()){j.update_header();setTimeout(function(){j.do_end()},700)}else{setTimeout(function(){j.do_next()},700)}},checkByPhonetic:function checkByPhonetic(a,c){return b.call([{methodname:"mod_wordcards_check_by_phonetic",args:{spoken:a,correct:c,language:j.props.language}}])[0]},wordsDoMatch:function wordsDoMatch(b,c){b=j.cleanText(b);c.term=j.cleanText(c.term);if(b==c.term){return!0}if(!c.alternates){return!1}var d=c.alternates.split(","),e=!1;a.each(d,function(a,c){if(j.cleanText(c.toLowerCase())==b){e=!0;return!1}});return e},cleanText:function cleanText(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function start(){j.results=[];d.shuffle(j.terms);j.controls.vocab_list.hide();j.controls.gameboard.show();j.controls.time_counter.text("00:00");j.clearStarRating();d.progress_dots(j.results,j.terms);j.timer={interval:setInterval(function(){j.timer.update()},1e3),count:0,update:function update(){j.timer.count++;j.controls.time_counter.text(d.pretty_print_secs(j.timer.count))}};j.update_header();this.initCards()},quit:function quit(){clearInterval(j.timer.interval);j.controls.gameboard.hide();j.controls.vocab_list.show()},do_end:function do_end(){clearInterval(j.timer.interval);a("#wordcards-gameboard, #wordcards-quit-button, #wordcards-start-button").hide();a("#wordcards-results").show();var c=[];c.results=j.results;c.total=j.terms.length;c.totalcorrect=d.calc_total_points(j.results);var e=j.timer.count;if(0==e){c.prettytime="00:00"}else{c.prettytime=d.pretty_print_secs(e)}h.render("mod_wordcards/feedback",c).then(function(b){a("#results-inner").html(b)});var f={results:j.results,activity:"speechcards"};console.log(f);b.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:j.modid,correct:c.totalcorrect}}])},is_end:function is_end(){if(j.pointer<j.terms.length){return!1}else{return!0}},update_header:function update_header(){({correct:100*(j.results.filter(function(a){return 0<a.points}).length/j.terms.length),incorrect:100*(j.results.filter(function(a){return 0==a.points}).length/j.terms.length)})},check:function check(b,c){var d=1;if(!0==b){d=1}else{d=0}a(".a4e-distractor").css("pointer-events","none");var e={pointer:j.pointer,question:j.terms[j.pointer-1].definition,selected:c,correct:j.terms[j.pointer-1].term,points:d};a.each(j.results,function(a){if(j.pointer===a.pointer){}});j.results.push(e);if(b){this.reportSuccess(j.terms[j.pointer-1].id)}else{this.reportFailure(j.terms[j.pointer-1].id,0)}},reportFailure:function reportFailure(a,c){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function reportSuccess(a){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-j.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){var a=!1;if(this.mobile_user()){a=!0}else if(this.chrome_user()){a=!1}else{a=!0}if(!1==a){return!1}switch(j.props.region){case"tokyo":case"useast1":case"dublin":case"sydney":a="en"===j.props.language.substr(0,2);break;default:a=!1;}return a}};return j});
//# sourceMappingURL=speechcards.min.js.map
