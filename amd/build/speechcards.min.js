define(["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","core/templates"],function(a,b,c,d,e,f,g){var h={pointer:1,whatheard:null,jsondata:null,glider:null,dryRun:!1,controls:{},init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl;var f=a(e).get(0);if(!f)return void c.debug("No config found on page. Giving up.");var f=JSON.parse(f.value);a(e).remove(),h.jsondata=f,h.process(f),h.whatheard=a("#submitted"),d.register_events(),this.init_controls(),this.register_events()},init_controls:function(){h.controls.close_results=a("#close-results"),h.controls.results=a("#results"),h.controls.vocab_list=a("#vocab-list"),h.controls.question_counter=a("#question-counter"),h.controls.quit_button=a("#quit-button"),h.controls.the_list=a("#speechcards_thelist"),h.controls.gameboard=a("#gameboard"),h.controls.time_counter=a("#time-counter"),h.controls.progress_correct=a("#progress-correct"),h.controls.progress_incorrect=a("#progress-incorrect"),h.controls.prev_button=a(".wordcards-speechcards_prevbutton"),h.controls.next_button=a(".wordcards-speechcards_nextbutton")},do_next:function(){h.is_end()?h.do_end():(h.whatheard.removeClass("wordcards-speechcards_gotit"),h.whatheard.text("........"),h.glider.go(">"),h.update_header())},do_prev:function(){h.whatheard.removeClass("wordcards-speechcards_gotit"),h.whatheard.text("........"),h.glider.go("<"),h.update_header()},register_events:function(){h.controls.prev_button.click(function(){h.do_prev(),h.update_whatheard()}),h.controls.next_button.click(function(){var a=h.terms[h.pointer-1].term;h.check(!1,a),h.do_next(),h.update_whatheard()}),a("body").on("click","#close-results",function(){var a=d.calc_total_time(h.results);window.location.replace(h.nexturl.replace("&amp;","&")+"&localscattertime="+a)}),a("body").on("click","#start-button",function(){h.start()}),h.controls.quit_button.click(function(){h.quit()})},process:function(a){h.terms=a.terms,h.has_images=a.has_images,d.list_vocab("#vocab-list-inner",h.terms),this.initComponents()},initCards:function(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){h.pointer=a}var c="<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>",d=h.controls.the_list;a.each(h.jsondata.terms,function(a,b){d.append(c.replace("@thetext@",b.term))}),h.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function(a){b(a.index),h.update_header()},afterInit:function(a){b(a.index)}}).data("glide_api")})},initComponents:function(){var a=function(a){switch(console.log(a),a.type){case"speech":var b=a.capturedspeech;h.whatheard.text(b);var c=h.cleanText(b);c===h.terms[h.pointer-1].term&&(h.whatheard.addClass("wordcards-speechcards_gotit"),h.check(!0,c),h.is_end()?(h.update_header(),setTimeout(function(){h.do_end()},700)):setTimeout(function(){h.do_next()},700))}};f.init("speechcards_pushrecorder",a)},cleanText:function(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function(){h.results=[],d.shuffle(h.terms),h.controls.vocab_list.hide(),h.controls.gameboard.show(),h.controls.quit_button.show(),h.controls.time_counter.text("00:00"),h.controls.progress_correct.css("width","0%"),h.controls.progress_incorrect.css("width","0%"),h.whatheard.text("........"),h.timer={interval:setInterval(function(){h.timer.update()},1e3),count:0,update:function(){h.timer.count++,h.controls.time_counter.text(d.pretty_print_secs(h.timer.count))}},h.update_header(),this.initCards()},quit:function(){clearInterval(h.timer.interval),h.controls.gameboard.hide(),h.controls.quit_button.hide(),h.controls.vocab_list.show()},do_end_jump:function(){clearInterval(h.timer.interval),h.controls.gameboard.hide(),h.controls.quit_button.hide();var b=0;a.each(h.results,function(a,c){null!=c.time&&(b+=c.time)}),window.location.replace(this.nexturl.replace("&amp;","&")+"&localscattertime="+b)},do_end:function(){clearInterval(h.timer.interval),a("#gameboard, #quit-button, #start-button").hide(),a("#results").show();var b=[];b.results=h.results,b.total=h.terms.length,b.totalcorrect=d.calc_total_points(h.results);var c=d.calc_total_time(h.results);0==c?b.prettytime="00:00":b.prettytime=d.pretty_print_secs(c),g.render("mod_wordcards/feedback",b).then(function(b,c){a("#results-inner").html(b)});var e={results:h.results,activity:"speechcards"};console.log(e)},is_end:function(){return!(h.pointer<h.terms.length)},update_whatheard:function(){a.each(h.results,function(a){h.pointer===a.pointer&&(h.whatheard.text(a.selected),h.cleanText(a.selected)===h.terms[h.pointer-1].term&&h.whatheard.addClass("wordcards-speechcards_gotit"))})},update_header:function(){var a={correct:h.results.filter(function(a){return a.points>0}).length/h.terms.length*100,incorrect:h.results.filter(function(a){return 0==a.points}).length/h.terms.length*100};h.controls.progress_correct.css("width",a.correct+"%"),h.controls.progress_incorrect.css("width",a.incorrect+"%"),h.controls.question_counter.text(h.pointer+"/"+h.terms.length)},check:function(b,c){var d=1;d=1==b?1:0,a(".a4e-distractor").css("pointer-events","none");var e={pointer:h.pointer,question:h.terms[h.pointer-1].definition,selected:c,correct:h.terms[h.pointer-1].term,points:d,time:h.timer.count};h.timer.count=0,a.each(h.results,function(a){h.pointer===a.pointer}),h.results.push(e),b?this.reportSuccess(h.terms[h.pointer-1].id):this.reportFailure(h.terms[h.pointer-1].id,-1)},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return h});