define ("mod_wordcards/speechcards",["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","mod_wordcards/transcriber-lazy","core/templates"],function(a,b,c,d,e,f,g,h){var j={pointer:1,whatheard:null,jsondata:null,props:null,glider:null,dryRun:!1,controls:{},browserspeech:!1,init:function init(b){var e="#"+b.widgetid;this.dryRun=b.dryRun;this.nexturl=b.nexturl;var f=a(e).get(0);if(f){var f=JSON.parse(f.value);a(e).remove()}else{c.debug("No config found on page. Giving up.");return}j.jsondata=f;j.props=b;j.process(f);j.whatheard=a("#submitted");j.browserspeech="webkitSpeechRecognition"in window||"SpeechRecognition"in window;d.register_events();this.init_controls();this.register_events()},init_controls:function init_controls(){j.controls.close_results=a("#close-results");j.controls.results=a("#results");j.controls.vocab_list=a("#vocab-list");j.controls.question_counter=a("#question-counter");j.controls.quit_button=a("#quit-button");j.controls.the_list=a("#speechcards_thelist");j.controls.gameboard=a("#gameboard");j.controls.time_counter=a("#time-counter");j.controls.progress_correct=a("#progress-correct");j.controls.progress_incorrect=a("#progress-incorrect");j.controls.prev_button=a(".wordcards-speechcards_prevbutton");j.controls.next_button=a(".wordcards-speechcards_nextbutton");j.controls.standalonepushrecorder=a(".speechcards_standalonerecorder")},do_next:function do_next(){if(!j.is_end()){j.whatheard.removeClass("wordcards-speechcards_gotit");j.whatheard.text("........");j.glider.go(">");j.update_header()}else{j.do_end()}},do_prev:function do_prev(){j.whatheard.removeClass("wordcards-speechcards_gotit");j.whatheard.text("........");j.glider.go("<");j.update_header()},register_events:function register_events(){j.controls.prev_button.click(function(){j.do_prev();j.update_whatheard()});j.controls.next_button.click(function(){var a=j.terms[j.pointer-1].term;j.check(!1,a);j.do_next();j.update_whatheard()});a("body").on("click","#close-results",function(){var a=d.calc_total_time(j.results);window.location.replace(j.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a)});a("body").on("click","#start-button",function(){j.start()});j.controls.quit_button.click(function(){j.quit()})},process:function process(a){j.terms=a.terms;j.has_images=a.has_images;d.list_vocab("#vocab-list-inner",j.terms);this.initComponents()},initCards:function initCards(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){j.pointer=a}var c=j.controls.the_list;a.each(j.jsondata.terms,function(a,b){c.append("<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>".replace("@thetext@",b.term))});j.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function afterTransition(a){b(a.index);j.update_header()},afterInit:function afterInit(a){b(a.index)}}).data("glide_api")})},initComponents:function initComponents(){var a=function(a){switch(a.type){case"recording":if(j.browserspeech){return}if("started"==a.action){j.startAWSTranscriber()}else if("stopped"==a.action){j.stopAWSTranscriber()}break;case"speech":var b=a.capturedspeech,c=j.cleanText(b);if(j.wordsDoMatch(c,j.terms[j.pointer-1])){j.whatheard.text(j.terms[j.pointer-1].term);j.whatheard.addClass("wordcards-speechcards_gotit");j.check(!0,c);if(j.is_end()){j.update_header();setTimeout(function(){j.do_end()},700)}else{setTimeout(function(){j.do_next()},700)}}else{j.whatheard.text(b)}}};f.init("speechcards_pushrecorder",a);var b={language:j.props.language,region:j.props.region,accessid:j.props.accessid,secretkey:j.props.secretkey};g.init(b);g.onFinalResult=function(b){a({type:"speech",capturedspeech:b})}},startAWSTranscriber:function startAWSTranscriber(){if(g.active){return}window.navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(function(a){g.start(a,g)}).catch(function(a){c.debug(a);c.debug("There was an error streaming your audio to Amazon Transcribe. Please try again.")})},stopAWSTranscriber:function stopAWSTranscriber(){if(!g.active){return}g.closeSocket()},wordsDoMatch:function wordsDoMatch(b,c){if(b==c.term){return!0}if(!c.alternates){return!1}var d=c.alternates.split(","),e=!1;a.each(d,function(a,c){if(j.cleanText(c)==b){e=!0;return!1}});return e},cleanText:function cleanText(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function start(){j.results=[];d.shuffle(j.terms);j.controls.vocab_list.hide();j.controls.gameboard.show();j.controls.quit_button.show();j.controls.time_counter.text("00:00");j.controls.progress_correct.css("width","0%");j.controls.progress_incorrect.css("width","0%");j.whatheard.text("........");j.timer={interval:setInterval(function(){j.timer.update()},1e3),count:0,update:function update(){j.timer.count++;j.controls.time_counter.text(d.pretty_print_secs(j.timer.count))}};j.update_header();this.initCards()},quit:function quit(){clearInterval(j.timer.interval);j.controls.gameboard.hide();j.controls.quit_button.hide();j.controls.vocab_list.show()},do_end:function do_end(){clearInterval(j.timer.interval);a("#gameboard, #quit-button, #start-button").hide();a("#results").show();var b=[];b.results=j.results;b.total=j.terms.length;b.totalcorrect=d.calc_total_points(j.results);var c=d.calc_total_time(j.results);if(0==c){b.prettytime="00:00"}else{b.prettytime=d.pretty_print_secs(c)}h.render("mod_wordcards/feedback",b).then(function(b){a("#results-inner").html(b)});var e={results:j.results,activity:"speechcards"};console.log(e)},is_end:function is_end(){if(j.pointer<j.terms.length){return!1}else{return!0}},update_whatheard:function update_whatheard(){a.each(j.results,function(a){if(j.pointer===a.pointer){j.whatheard.text(a.selected);if(j.cleanText(a.selected)===j.terms[j.pointer-1].term){j.whatheard.addClass("wordcards-speechcards_gotit")}}})},update_header:function update_header(){var a={correct:100*(j.results.filter(function(a){return 0<a.points}).length/j.terms.length),incorrect:100*(j.results.filter(function(a){return 0==a.points}).length/j.terms.length)};j.controls.progress_correct.css("width",a.correct+"%");j.controls.progress_incorrect.css("width",a.incorrect+"%");j.controls.question_counter.text(j.pointer+"/"+j.terms.length)},check:function check(b,c){var d=1;if(!0==b){d=1}else{d=0}a(".a4e-distractor").css("pointer-events","none");var e={pointer:j.pointer,question:j.terms[j.pointer-1].definition,selected:c,correct:j.terms[j.pointer-1].term,points:d,time:j.timer.count};j.timer.count=0;a.each(j.results,function(a){if(j.pointer===a.pointer){}});j.results.push(e);if(b){this.reportSuccess(j.terms[j.pointer-1].id)}else{this.reportFailure(j.terms[j.pointer-1].id,-1)}},reportFailure:function reportFailure(a,c){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function reportSuccess(a){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return j});
//# sourceMappingURL=speechcards.min.js.map
