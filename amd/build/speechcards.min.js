define(["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader"],function(a,b,c,d,e,f){var g={pointer:1,whatheard:null,jsondata:null,glider:null,dryRun:!1,controls:{},init:function(b){var e="#"+b.widgetid;this.dryRun=b.dryRun,this.nexturl=b.nexturl;var f=a(e).get(0);if(!f)return void c.debug("No config found on page. Giving up.");var f=JSON.parse(f.value);a(e).remove(),g.jsondata=f,g.process(f),g.whatheard=a("#submitted"),d.register_events(),this.init_controls(),this.register_events()},init_controls:function(){g.controls.close_results=a("#close-results"),g.controls.results=a("#results"),g.controls.vocab_list=a("#vocab-list"),g.controls.question_counter=a("#question-counter"),g.controls.quit_button=a("#quit-button"),g.controls.the_list=a("#speechcards_thelist"),g.controls.gameboard=a("#gameboard"),g.controls.time_counter=a("#time-counter"),g.controls.progress_correct=a("#progress-correct"),g.controls.progress_incorrect=a("#progress-incorrect"),g.controls.prev_button=a(".wordcards-speechcards_prevbutton"),g.controls.next_button=a(".wordcards-speechcards_nextbutton")},do_next:function(){g.is_end()?g.do_end():(g.whatheard.removeClass("wordcards-speechcards_gotit"),g.whatheard.text("........"),g.glider.go(">"),g.update_header())},do_prev:function(){g.whatheard.removeClass("wordcards-speechcards_gotit"),g.whatheard.text("........"),g.glider.go("<"),g.update_header()},register_events:function(){g.controls.prev_button.click(function(){g.do_prev(),g.update_whatheard()}),g.controls.next_button.click(function(){var a=g.terms[g.pointer-1].term;g.check(!1,a),g.do_next(),g.update_whatheard()}),a("body").on("click","#close-results",function(){g.controls.results.hide(),g.controls.vocab_list.show();var a=d.calc_total_time(g.results);window.location.replace(g.nexturl.replace("&amp;","&")+"&localscattertime="+a)}),a("body").on("click","#start-button",function(){g.start()}),g.controls.quit_button.click(function(){g.quit()})},process:function(a){g.terms=a.terms,g.has_images=a.has_images,d.list_vocab("#vocab-list-inner",g.terms),this.initComponents()},initCards:function(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){g.pointer=a}var c="<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>",d=g.controls.the_list;a.each(g.jsondata.terms,function(a,b){d.append(c.replace("@thetext@",b.term))}),g.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function(a){b(a.index)},afterInit:function(a){b(a.index)}}).data("glide_api")})},initComponents:function(){var a=function(a){switch(console.log(a),a.type){case"speech":var b=a.capturedspeech;g.whatheard.text(b);var c=g.cleanText(b);c===g.terms[g.pointer-1].term&&(g.whatheard.addClass("wordcards-speechcards_gotit"),g.check(!0,c),g.is_end()?(g.update_header(),setTimeout(function(){g.do_end()},700)):setTimeout(function(){g.do_next()},700))}};f.init("speechcards_pushrecorder",a)},cleanText:function(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function(){g.results=[],d.shuffle(g.terms),g.controls.vocab_list.hide(),g.controls.gameboard.show(),g.controls.quit_button.show(),g.controls.time_counter.text("00:00"),g.controls.progress_correct.css("width","0%"),g.controls.progress_incorrect.css("width","0%"),g.whatheard.text("........"),g.timer={interval:setInterval(function(){g.timer.update()},1e3),count:0,update:function(){g.timer.count++,g.controls.time_counter.text(d.pretty_print_secs(g.timer.count))}},g.update_header(),this.initCards()},quit:function(){clearInterval(g.timer.interval),g.controls.gameboard.hide(),g.controls.quit_button.hide(),g.controls.vocab_list.show()},do_end_jump:function(){clearInterval(g.timer.interval),g.controls.gameboard.hide(),g.controls.quit_button.hide();var b=0;a.each(g.results,function(a,c){null!=c.time&&(b+=c.time)}),window.location.replace(this.nexturl.replace("&amp;","&")+"&localscattertime="+b)},do_end:function(){clearInterval(g.timer.interval),a("#gameboard, #quit-button, #start-button").hide(),a("#results").show();var b=[];b.results=g.results,b.total=g.terms.length,b.totalcorrect=d.calc_total_points(g.results);var c=d.calc_total_time(g.results);0==c?b.prettytime="00:00":b.prettytime=d.pretty_print_secs(c),templates.render("mod_wordcards/feedback",b).then(function(b,c){a("#results-inner").html(b)});var e={results:g.results,activity:"speechcards"};console.log(e)},is_end:function(){return!(g.pointer<g.terms.length)},update_whatheard:function(){a.each(g.results,function(a){g.pointer===a.pointer&&(g.whatheard.text(a.selected),g.cleanText(a.selected)===g.terms[g.pointer-1].term&&g.whatheard.addClass("wordcards-speechcards_gotit"))})},update_header:function(){var a={correct:g.results.filter(function(a){return a.points>0}).length/g.terms.length*100,incorrect:g.results.filter(function(a){return 0==a.points}).length/g.terms.length*100};g.controls.progress_correct.css("width",a.correct+"%"),g.controls.progress_incorrect.css("width",a.incorrect+"%"),g.controls.question_counter.text(g.pointer+"/"+g.terms.length)},check:function(b,c){var d=1;d=1==b?1:0,a(".a4e-distractor").css("pointer-events","none");var e={pointer:g.pointer,question:g.terms[g.pointer-1].definition,selected:c,correct:g.terms[g.pointer-1].term,points:d,time:g.timer.count};g.timer.count=0,a.each(g.results,function(a){g.pointer===a.pointer}),g.results.push(e),b?this.reportSuccess(g.terms[g.pointer-1].id):this.reportFailure(g.terms[g.pointer-1].id,-1)},get_distractors:function(){var b=g.terms.slice(0),c=g.terms[g.pointer-1].term;b.splice(g.pointer-1,1),d.shuffle(b),b=b.slice(0,4),b.push(g.terms[g.pointer-1]),d.shuffle(b);var e=[];a.each(b,function(a,b){var d=b.term==c,f=b.id;e.push('<li data-id="'+f+'" data-correct="'+d.toString()+'" class="list-group-item a4e-distractor a4e-noselect">'+b.term+"</li>")});var f='<ul class="list-group a4e-distractors">'+e.join("")+"</ul>";return f},reportFailure:function(a,c){this.dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function(a){this.dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])}};return g});