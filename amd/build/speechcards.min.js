define ("mod_wordcards/speechcards",["jquery","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/glidecards","mod_wordcards/cloudpoodllloader","core/templates"],function(a,b,c,d,e,f,g){var h={passmark:75,pointer:1,jsondata:null,props:null,glider:null,dryRun:!1,controls:{},init:function init(b){var e="#"+b.widgetid;this.dryRun=b.dryRun;this.nexturl=b.nexturl;this.modid=b.modid;var f=a(e).get(0);if(f){var g=JSON.parse(f.value);a(e).remove()}else{c.debug("No config found on page. Giving up.");return}h.jsondata=g;h.props=b;h.process(g);d.register_events();d.init_audio(b.token,b.region,b.owner);this.init_controls();this.register_events()},init_controls:function init_controls(){h.controls.close_results=a("#close-results");h.controls.results=a("#results");h.controls.vocab_list=a("#vocab-list");h.controls.the_list=a("#speechcards_thelist");h.controls.gameboard=a("#gameboard");h.controls.time_counter=a("#time-counter");h.controls.prev_button=a(".wordcards-speechcards_prevbutton");h.controls.next_button=a(".wordcards-speechcards_nextbutton");h.controls.standalonepushrecorder=a(".speechcards_standalonerecorder")},do_next:function do_next(){d.progress_dots(h.results,h.terms);h.clearStarRating();if(!h.is_end()){h.glider.go(">");h.update_header()}else{h.do_end()}},do_prev:function do_prev(){h.glider.go("<");h.update_header()},clearStarRating:function clearStarRating(){a("#star-rating").html("\xB7 \xB7 \xB7")},register_events:function register_events(){h.controls.prev_button.click(function(){h.do_prev()});h.controls.next_button.click(function(){var a=h.terms[h.pointer-1].term;h.check(!1,a);h.do_next()});a("body").on("click","#close-results",function(){var a=h.timer.count,b=h.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a;window.location.replace(b)});a("body").on("click","#try-again",function(){location.reload()});a("body").on("click","#start-button",function(){h.start()})},process:function process(a){h.terms=a.terms;h.has_images=a.has_images;d.list_vocab("#vocab-list-inner",h.terms);this.initComponents()},initCards:function initCards(){a.getScript("https://cdn.jsdelivr.net/npm/glidejs@2.1.0/dist/glide.min.js").done(function(){function b(a){h.pointer=a}var c=h.controls.the_list;a.each(h.jsondata.terms,function(a,b){c.append("<li class='glide__slide'><div class='wordcards-poodllspeechcards_box'>@thetext@</div></li>".replace("@thetext@",b.term))});h.glider=a("#speechcards_glide").glide({type:"carousel",autoplay:!1,afterTransition:function afterTransition(a){b(a.index);h.update_header()},afterInit:function afterInit(a){b(a.index)}}).data("glide_api")})},initComponents:function initComponents(){f.init("speechcards_pushrecorder",function theCallback(b){console.log(b);switch(b.type){case"recording":break;case"speech":var d=b.capturedspeech,e=h.cleanText(d),f=e,g=h.terms[h.pointer-1].term,i=h.similarity(f,g);c.debug("JS similarity: "+f+":"+g+":"+i);if(i>=h.passmark||h.wordsDoMatch(e,h.terms[h.pointer-1])){c.debug("local match::"+f+":"+g);h.showStarRating(100);h.flagCorrectAndTransition(h.terms[h.pointer-1]);return}h.checkByPhonetic(f,g).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+f+":"+g+":"+b);h.showStarRating(b);if(b>=h.passmark){h.flagCorrectAndTransition(b,h.terms[h.pointer-1])}}});}})},showStarRating:function showStarRating(b){var c=[!0,!0,!0];if(1>b){c=[!0,!0,!1]}if(b<h.passmark){c=[!0,!1,!1]}if(.5>b){c=[!1,!1,!1]}console.log(c,b);var d="";c.forEach(function(a){if(!0===a){d+="<i class=\"fa fa-star\"></i>"}else{d+="<i class=\"fa fa-star-o\"></i>"}});console.log(d);a("#star-rating").html(d)},flagCorrectAndTransition:function flagCorrectAndTransition(a){h.check(!0,a);if(h.is_end()){h.update_header();setTimeout(function(){h.do_end()},700)}else{setTimeout(function(){h.do_next()},700)}},checkByPhonetic:function checkByPhonetic(a,c){return b.call([{methodname:"mod_wordcards_check_by_phonetic",args:{spoken:a,correct:c,language:h.props.language}}])[0]},wordsDoMatch:function wordsDoMatch(b,c){b=h.cleanText(b);c.term=h.cleanText(c.term);if(b==c.term){return!0}if(!c.alternates){return!1}var d=c.alternates.split(","),e=!1;a.each(d,function(a,c){if(h.cleanText(c.toLowerCase())==b){e=!0;return!1}});return e},cleanText:function cleanText(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},start:function start(){h.results=[];d.shuffle(h.terms);h.controls.vocab_list.hide();h.controls.gameboard.show();h.controls.time_counter.text("00:00");h.clearStarRating();d.progress_dots(h.results,h.terms);h.timer={interval:setInterval(function(){h.timer.update()},1e3),count:0,update:function update(){h.timer.count++;h.controls.time_counter.text(d.pretty_print_secs(h.timer.count))}};h.update_header();this.initCards()},quit:function quit(){clearInterval(h.timer.interval);h.controls.gameboard.hide();h.controls.vocab_list.show()},do_end:function do_end(){clearInterval(h.timer.interval);a("#gameboard, #quit-button, #start-button").hide();a("#results").show();var c=[];c.results=h.results;c.total=h.terms.length;c.totalcorrect=d.calc_total_points(h.results);var e=h.timer.count;if(0==e){c.prettytime="00:00"}else{c.prettytime=d.pretty_print_secs(e)}g.render("mod_wordcards/feedback",c).then(function(b){a("#results-inner").html(b)});var f={results:h.results,activity:"speechcards"};console.log(f);b.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:h.modid,correct:c.totalcorrect}}])},is_end:function is_end(){if(h.pointer<h.terms.length){return!1}else{return!0}},update_header:function update_header(){({correct:100*(h.results.filter(function(a){return 0<a.points}).length/h.terms.length),incorrect:100*(h.results.filter(function(a){return 0==a.points}).length/h.terms.length)})},check:function check(b,c){var d=1;if(!0==b){d=1}else{d=0}a(".a4e-distractor").css("pointer-events","none");var e={pointer:h.pointer,question:h.terms[h.pointer-1].definition,selected:c,correct:h.terms[h.pointer-1].term,points:d};a.each(h.results,function(a){if(h.pointer===a.pointer){}});h.results.push(e);if(b){this.reportSuccess(h.terms[h.pointer-1].id)}else{this.reportFailure(h.terms[h.pointer-1].id,-1)}},reportFailure:function reportFailure(a,c){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},reportSuccess:function reportSuccess(a){if(this.dryRun){return}b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-h.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]}};return h});
//# sourceMappingURL=speechcards.min.js.map
