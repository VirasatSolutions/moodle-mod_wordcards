define(["jquery","core/ajax"],function(a,b){function c(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}var d=60,e=4,f=function(b,c){this._container=a(b),this._terms=c,this._selected=null};return f.prototype._container=null,f.prototype._dryRun=!1,f.prototype._resizeTimeout=null,f.prototype._selected=null,f.prototype._terms=null,f.prototype.init=function(){var b=[];this._terms.forEach(function(a){b.push(this._makeCard(a.id,a.term)),b.push(this._makeCard(a.id,a.definition))}.bind(this)),c(b),b.forEach(function(a){this._container.append(a)}.bind(this)),this._arrangePlayground(),b.forEach(function(a){a.show()}),this._container.on("click",".wordcard",this._handlePick.bind(this)),a(window).on("resize",function(){this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._arrangePlayground.bind(this),200)}.bind(this))},f.prototype._arrangePlayground=function(){var b,c,f,g,h=this._container.width(),i=a(window).height(),j=3,k=2*this._terms.length,l=null,m=null,n=0,o=0;k%2<k%3&&(j=2),b=this._container.find(".wordcard").first().css("lineHeight"),c=parseInt(b.replace(/([^0-9]+)/,"")),f=b.replace(/([0-9]+)/,""),g=60,"px"===f&&(g=c?3*(c+1):g),g=999,l=Math.floor(h/j),m=Math.min(Math.round((i-d)/Math.ceil(k/j)),g),this._container.find(".wordcard").each(function(b,c){a(c).css({top:n*m,left:o*l,width:o==j-1?l:l-e,height:m-e}),o++,o>=j&&(o=0,n++)}),this._container.find(".wordcard-content").css("maxHeight",m-e),this._container.css({height:n*m}),this._adjustCardContent()},f.prototype._adjustCardContent=function(){this._container.find(".wordcard-content").each(function(b,c){var d,e,f=a(c),g=0;for(f.text(f.data("text"));c.scrollHeight>c.offsetHeight&&c.scrollHeight>0&&(e=f.text(),d=Math.max(.1,c.offsetHeight/c.scrollHeight-.05),e=e.substr(0,Math.round(e.length*d)).trim(),e+="â€¦",f.text(e),!(g++>4)););})},f.prototype._checkComplete=function(){this._container.find(".wordcard.found").length==2*this._terms.length&&this._trigger("complete")},f.prototype._handlePick=function(b){b.preventDefault();var c=a(b.currentTarget);if(!c.hasClass("found")){if(!this._selected)return this._selected=c,void c.addClass("selected");if(!this._selected.is(c)){if(c.data("id")==this._selected.data("id"))this._selected.addClass("found").animate({opacity:0}),c.addClass("found").animate({opacity:0}),this._reportSuccess(this._selected.data("id")),this._checkComplete();else{var d=this._selected;d.addClass("mismatch"),c.addClass("mismatch"),this._reportFailure(this._selected.data("id"),c.data("id")),setTimeout(function(){d.removeClass("mismatch"),c.removeClass("mismatch")},600)}this._selected.removeClass("selected"),this._selected=null}}},f.prototype._makeCard=function(b,c){var d=a('<div class="wordcard">'),e=a('<div class="wordcard-wrapper">'),f=a('<div class="wordcard-content">');return f.text(c),f.data("text",c),e.append(f),d.append(e),d.data("id",b),d},f.prototype.on=function(a,b){this._container.on(a,b)},f.prototype._reportFailure=function(a,c){this._dryRun||b.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:c}}])},f.prototype._reportSuccess=function(a){this._dryRun||b.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])},f.prototype.setDryRun=function(a){this._dryRun=a},f.prototype._trigger=function(a){this._container.trigger(a)},f});