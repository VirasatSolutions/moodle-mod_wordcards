define(["jquery","core/ajax"],function(a,b){function c(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}var d=function(b,c){this._container=a(b),this._terms=c,this._selected=null};return d.prototype._container=null,d.prototype._dryRun=!1,d.prototype._selected=null,d.prototype._terms=null,d.prototype.init=function(){var b=[],d=this._container.width(),e=a(window).height(),f=3,g=2*this._terms.length;g%3>g%2&&(f=2);var h=Math.floor(d/f),i=Math.min(Math.round((e-50)/Math.ceil(g/f)),60);this._terms.forEach(function(a){b.push(this._makeCard(a.id,a.term)),b.push(this._makeCard(a.id,a.definition))}.bind(this));var j=0,k=0;c(b),b.forEach(function(a){a.css({top:j*i,left:k*h,width:k==f-1?h:h-4,height:i-4}),this._container.append(a),k++,k>=f&&(k=0,j++)}.bind(this)),this._container.css({height:j*i}),this._container.on("click",".flashcard",this._handlePick.bind(this))},d.prototype._checkComplete=function(){this._container.find(".flashcard.found").length==2*this._terms.length&&this._trigger("complete")},d.prototype._handlePick=function(b){b.preventDefault();var c=a(b.currentTarget);if(!c.hasClass("found")){if(!this._selected)return this._selected=c,void c.addClass("selected");if(!this._selected.is(c)){if(c.data("id")==this._selected.data("id"))this._selected.addClass("found").animate({opacity:0}),c.addClass("found").animate({opacity:0}),this._reportSuccess(this._selected.data("id")),this._checkComplete();else{var d=this._selected;d.addClass("mismatch"),c.addClass("mismatch"),this._reportFailure(this._selected.data("id"),c.data("id")),setTimeout(function(){d.removeClass("mismatch"),c.removeClass("mismatch")},600)}this._selected.removeClass("selected"),this._selected=null}}},d.prototype._makeCard=function(b,c){var d=a('<div class="flashcard">').data("id",b);return d.append(a("<div>").text(c)),d},d.prototype.on=function(a,b){this._container.on(a,b)},d.prototype._reportFailure=function(a,c){this._dryRun||b.call([{methodname:"mod_flashcards_report_failed_association",args:{term1id:a,term2id:c}}])},d.prototype._reportSuccess=function(a){this._dryRun||b.call([{methodname:"mod_flashcards_report_successful_association",args:{termid:a}}])},d.prototype.setDryRun=function(a){this._dryRun=a},d.prototype._trigger=function(a){this._container.trigger(a)},d});