define(["jquery","core/ajax"],function(a,b){function c(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}var d=function(b,c){this._container=a(b),this._terms=c,this._selected=null};return d.prototype._container=null,d.prototype._dryRun=!1,d.prototype._resizeTimeout=null,d.prototype._selected=null,d.prototype._terms=null,d.prototype.init=function(){var b=[];this._terms.forEach(function(a){b.push(this._makeCard(a.id,a.term)),b.push(this._makeCard(a.id,a.definition))}.bind(this)),c(b),b.forEach(function(a){this._container.append(a)}.bind(this)),this._arrangePlayground(),b.forEach(function(a){a.show()}),this._container.on("click",".flashcard",this._handlePick.bind(this)),a(window).on("resize",function(){this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._arrangePlayground.bind(this),200)}.bind(this))},d.prototype._arrangePlayground=function(){var b,c,d,e,f=this._container.width(),g=a(window).height(),h=3,i=2*this._terms.length,j=null,k=null,l=0,m=0;i%3>i%2&&(h=2),b=this._container.find(".flashcard").first().css("lineHeight"),c=parseInt(b.replace(/([^0-9]+)/,"")),d=b.replace(/([0-9]+)/,""),e=60,"px"===d&&(e=c?3*(c+1):e),j=Math.floor(f/h),k=Math.min(Math.round((g-50)/Math.ceil(i/h)),e),this._container.find(".flashcard").each(function(b,c){a(c).css({top:l*k,left:m*j,width:m==h-1?j:j-4,height:k-4}),m++,m>=h&&(m=0,l++)}),this._container.find(".flashcard-content").css("maxHeight",k-4),this._container.css({height:l*k}),this._adjustCardContent()},d.prototype._adjustCardContent=function(){this._container.find(".flashcard-content").each(function(b,c){var d,e,f=a(c),g=0;for(f.text(f.data("text"));c.scrollHeight>c.offsetHeight&&c.scrollHeight>0&&(e=f.text(),d=Math.max(.1,c.offsetHeight/c.scrollHeight-.05),e=e.substr(0,Math.round(e.length*d)).trim(),e+="â€¦",f.text(e),!(g++>4)););})},d.prototype._checkComplete=function(){this._container.find(".flashcard.found").length==2*this._terms.length&&this._trigger("complete")},d.prototype._handlePick=function(b){b.preventDefault();var c=a(b.currentTarget);if(!c.hasClass("found")){if(!this._selected)return this._selected=c,void c.addClass("selected");if(!this._selected.is(c)){if(c.data("id")==this._selected.data("id"))this._selected.addClass("found").animate({opacity:0}),c.addClass("found").animate({opacity:0}),this._reportSuccess(this._selected.data("id")),this._checkComplete();else{var d=this._selected;d.addClass("mismatch"),c.addClass("mismatch"),this._reportFailure(this._selected.data("id"),c.data("id")),setTimeout(function(){d.removeClass("mismatch"),c.removeClass("mismatch")},600)}this._selected.removeClass("selected"),this._selected=null}}},d.prototype._makeCard=function(b,c){var d=a('<div class="flashcard">'),e=a('<div class="flashcard-wrapper">'),f=a('<div class="flashcard-content">');return f.text(c),f.data("text",c),e.append(f),d.append(e),d.data("id",b),d},d.prototype.on=function(a,b){this._container.on(a,b)},d.prototype._reportFailure=function(a,c){this._dryRun||b.call([{methodname:"mod_flashcards_report_failed_association",args:{term1id:a,term2id:c}}])},d.prototype._reportSuccess=function(a){this._dryRun||b.call([{methodname:"mod_flashcards_report_successful_association",args:{termid:a}}])},d.prototype.setDryRun=function(a){this._dryRun=a},d.prototype._trigger=function(a){this._container.trigger(a)},d});