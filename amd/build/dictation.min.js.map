{"version":3,"sources":["../src/dictation.js"],"names":["define","$","Ajax","log","a4e","keyboard","polly","templates","app","dryRun","audio","ttslanguage","init","props","theid","widgetid","nexturl","modid","configcontrol","get","definitionsdata","JSON","parse","value","remove","debug","register_events","init_audio","token","region","owner","process","aplayer","on","total_time","timer","count","url","replace","window","location","reload","click","attr","play","fetch_polly_url","tts","ttsvoice","onnewpollyurl","theurl","start","quit","json","terms","has_images","list_vocab","results","shuffle","pointer","hide","show","text","interval","setInterval","update","pretty_print_secs","next","clear","clearInterval","end","tdata","length","calc_total_points","render","then","html","data","activity","console","call","methodname","args","correct","progress_dots","removeClass","create","disable","check","trigger","selected","toLowerCase","trim","points","addClass","reportSuccess","reportFailure","result","question","push","setTimeout","term1id","term2id","termid"],"mappings":"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","sourcesContent":["/**\n * Matching module.\n *\n * @package mod_wordcards\n * @author  Justin Hunt - poodll.com\n * * (based on Paul Raine's APPs 4 EFL)\n */\n\ndefine([\n  'jquery',\n  'core/ajax',\n  'core/log',\n  'mod_wordcards/a4e',\n  'mod_wordcards/keyboard',\n  'mod_wordcards/pollyhelper',\n  'core/templates'\n], function($, Ajax, log, a4e, keyboard, polly, templates) {\n\n  var app = {\n    dryRun: false,\n    audio: false,\n    ttslanguage: 'en-US',\n    init: function(props) {\n\n      //pick up opts from html\n      var theid = '#' + props.widgetid;\n      this.dryRun = props.dryRun;\n      this.nexturl = props.nexturl;\n      this.modid = props.modid;\n      var configcontrol = $(theid).get(0);\n      if (configcontrol) {\n        var definitionsdata = JSON.parse(configcontrol.value);\n        $(theid).remove();\n      } else {\n        //if there is no config we might as well give up\n        log.debug('No config found on page. Giving up.');\n        return;\n      }\n\n      a4e.register_events();\n      a4e.init_audio(props.token,props.region,props.owner);\n\n      polly.init(props.token, props.region, props.owner);\n      app.ttslanguage = props.ttslanguage;\n      app.process(definitionsdata);\n\n\n\n      this.register_events();\n    },\n\n    register_events: function() {\n\n      // Get the audio element\n      var aplayer = $(\"#dictation_player\");\n\n      $('body').on('click', \"#wordcards-close-results\", function() {\n\n        var total_time = app.timer.count;\n        var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\n        window.location.replace(url);\n\n      });\n\n      $('body').on('click', \"#wordcards-try-again\", function() {\n        location.reload();\n      });\n\n      $(\"#listen-button\").click(function() {\n        if (app.audio) {\n          aplayer.attr('src', app.audio);\n          aplayer[0].play();\n        } else {\n          polly.fetch_polly_url(app.tts, 'text', app.ttsvoice);\n        }\n\n      });\n\n      //play what was returned in polly.fetch_polly_url\n      polly.onnewpollyurl = function(theurl) {\n        aplayer.attr('src', theurl);\n        aplayer[0].play();\n      };\n\n      $('body').on('click', '#wordcards-start-button', function() {\n        app.start();\n      });\n\n      $('body').on('click', '#wordcards-quit-button', function() {\n        app.quit();\n      });\n\n\n    },\n\n    process: function(json) {\n\n      app.terms = json.terms;\n      app.has_images = json.has_images;\n      a4e.list_vocab(\"#vocab-list-inner\", app.terms);\n\n    },\n    start: function() {\n      app.results = [];\n      a4e.shuffle(app.terms);\n      app.pointer = 0;\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").hide();\n      $(\"#wordcards-gameboard, #wordcards-quit-button\").show();\n      $(\"#wordcards-time-counter\").text(\"00:00\");\n      app.timer = {\n        interval: setInterval(function() {\n          app.timer.update();\n        }, 1000),\n        count: 0,\n        update: function() {\n          app.timer.count++;\n          $(\"#wordcards-time-counter\").text(a4e.pretty_print_secs(app.timer.count));\n        }\n      };\n      app.next();\n    },\n    quit: function() {\n      keyboard.clear();\n      clearInterval(app.timer.interval);\n      $(\"#wordcards-gameboard, #wordcards-quit-button\").hide();\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").show();\n    },\n\n    end: function() {\n      keyboard.clear();\n      clearInterval(app.timer.interval);\n      $(\"#wordcards-gameboard, #wordcards-quit-button, #wordcards-start-button\").hide();\n      $(\"#wordcards-results\").show();\n\n      //template data\n      var tdata = [];\n      tdata['results'] = app.results;\n      tdata['total'] = app.terms.length;\n      tdata['totalcorrect'] = a4e.calc_total_points(app.results);\n      var total_time = app.timer.count;\n      if (total_time == 0) {\n        tdata['prettytime'] = '00:00';\n      } else {\n        tdata['prettytime'] = a4e.pretty_print_secs(total_time);\n      }\n      templates.render('mod_wordcards/feedback', tdata).then(\n        function(html, js) {\n          $(\"#results-inner\").html(html);\n        }\n      );\n\n      var data = {\n        results: app.results,\n        activity: \"dictation\"\n      };\n      console.log(data);\n\n      Ajax.call([{\n          methodname: 'mod_wordcards_report_step_grade',\n          args: {\n              modid: app.modid,\n              correct: tdata['totalcorrect']\n          }\n      }]);\n\n    },\n\n\n    next: function() {\n      \n      a4e.progress_dots(app.results, app.terms);\n\n      $(\"#wordcards-submitted\").html(\"\").removeClass(\"a4e-correct a4e-incorrect\");\n\n      keyboard.create(\"wordcards-input\", app.terms[app.pointer]['term'], app.pointer, true, function(value) {\n        $(\"#wordcards-submitted\").html(app.terms[app.pointer]['term']);\n        keyboard.disable();\n        app.check(value);\n      });\n\n      app.tts = app.terms[app.pointer]['term'];\n      \n      if (app.terms[app.pointer]['ttsvoice']) {\n        app.ttsvoice = app.terms[app.pointer]['ttsvoice'];\n      } \n      \n      else {\n        app.ttsvoice = 'auto';\n      }\n      \n      if (app.terms[app.pointer]['audio']) {\n        app.audio = app.terms[app.pointer]['audio'];\n      } \n      \n      else {\n        app.audio = false;\n      }\n      \n      $(\"#listen-button\").trigger(\"click\");\n\n    },\n\n    check: function(selected) {\n      var correct = selected.toLowerCase().trim() == app.terms[app.pointer]['term'].toLowerCase().trim();\n      var points = 0;\n      if (correct == true) {\n        //createjs.Sound.play('correct');\n        $(\"#wordcards-submitted\").addClass(\"a4e-correct\");\n        points = 1;\n      } else {\n        $(\"#wordcards-submitted\").addClass(\"a4e-incorrect\");\n        //createjs.Sound.play('incorrect');\n      }\n\n      //post results to server\n      if (correct) {\n        this.reportSuccess(app.terms[app.pointer]['id']);\n      } else {\n        this.reportFailure(app.terms[app.pointer]['id'], 0);\n      }\n\n      var result = {\n        question: app.terms[app.pointer]['definition'],\n        selected: selected,\n        correct: app.terms[app.pointer]['term'],\n        points: points\n      };\n      \n      app.results.push(result);\n\n      if (app.pointer < app.terms.length - 1) {\n        app.pointer++;\n        setTimeout(function() {\n          app.next();\n        }, 1000)\n      } else {\n        app.end();\n      }\n\n\n    },\n\n    reportFailure: function(term1id, term2id) {\n      if (this.dryRun) {\n        return;\n      }\n\n      Ajax.call([{\n        methodname: 'mod_wordcards_report_failed_association',\n        args: {\n          term1id: term1id,\n          term2id: term2id\n        }\n      }]);\n    },\n\n    reportSuccess: function(termid) {\n      if (this.dryRun) {\n        return;\n      }\n\n      Ajax.call([{\n        methodname: 'mod_wordcards_report_successful_association',\n        args: {\n          termid: termid\n        }\n      }]);\n    }\n  };\n\n  return app;\n\n});"],"file":"dictation.min.js"}